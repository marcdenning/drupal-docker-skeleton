version: '3'

services:
  mariadb:
    image: 'bitnami/mariadb:10.5'
    ports:
      - '3306:3306'
    env_file: .mariadb.env
    volumes:
      - 'mariadb_data:/bitnami/mariadb'
  nginx:
    image: 'bitnami/nginx:1.19.10'
    ports:
      - '8080:8080'
    volumes:
      - './config/nginx/drupal.conf:/opt/bitnami/nginx/conf/server_blocks/drupal.conf'
      - 'drupal_app:/app:ro'
      - 'drupal_data:/app/web/sites/default/files:ro'
    depends_on:
      - drupal
  drupal:
    build:
      context: ./
      dockerfile: Dockerfile
    volumes:
      - 'drupal_app:/app'
      - './config/drupal/settings.php:/app/web/sites/default/settings.php' # Comment this line out the first time starting the container
      - 'drupal_data:/app/web/sites/default/files'
      - './config/drupal/sync:/app/sync'
    depends_on:
      - mariadb
  aws:
    image: 'localstack/localstack:0.12.15'
    environment:
      - AWS_DEFAULT_REGION=us-east-1
      - DATA_DIR=/tmp/localstack/data
      - EDGE_PORT=4566
      - SERVICES=s3
    ports:
      - '4566-4583:4566-4583'
    volumes:
      - 'localstack_data:/tmp/localstack'

volumes:
  mariadb_data:
  drupal_app:
  drupal_data:
  localstack_data:
